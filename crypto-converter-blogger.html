
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Crypto Currency Converter</title>
  <style>
    /* Base Styles */
    :root {
      --background: #ffffff;
      --foreground: #020817;
      --card: #ffffff;
      --card-foreground: #020817;
      --border: #e2e8f0;
      --input: #e2e8f0;
      --primary: #0f172a;
      --primary-foreground: #ffffff;
      --secondary: #f1f5f9;
      --secondary-foreground: #0f172a;
      --accent: #f1f5f9;
      --accent-foreground: #0f172a;
      --destructive: #ef4444;
      --destructive-foreground: #f8fafc;
      --muted: #f1f5f9;
      --muted-foreground: #64748b;
      --radius: 0.5rem;
      --font-sans: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    }

    /* RTL support */
    [dir="rtl"] {
      text-align: right;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: var(--font-sans);
      background-color: var(--background);
      color: var(--foreground);
      line-height: 1.5;
    }

    /* Typography */
    h1, h2, h3, h4 {
      font-weight: 600;
      line-height: 1.2;
    }

    /* Layout */
    .container {
      width: 100%;
      max-width: 1024px;
      margin: 0 auto;
      padding: 1rem;
    }

    /* Card */
    .card {
      background-color: var(--card);
      border-radius: var(--radius);
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      padding: 1.5rem;
      margin-bottom: 1rem;
    }

    .card-title {
      font-size: 1.25rem;
      margin-bottom: 1rem;
    }

    /* Form Elements */
    .form-group {
      margin-bottom: 1rem;
    }

    label {
      display: block;
      font-size: 0.875rem;
      font-weight: 500;
      margin-bottom: 0.5rem;
    }

    input,
    select {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background-color: var(--background);
      font-size: 1rem;
    }

    input:focus,
    select:focus {
      outline: 2px solid var(--primary);
      outline-offset: -1px;
    }

    /* Button */
    .button {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: var(--radius);
      padding: 0.5rem 1rem;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      border: none;
    }

    .button-primary {
      background-color: var(--primary);
      color: var(--primary-foreground);
    }

    .button-primary:hover {
      opacity: 0.9;
    }

    .button-outline {
      background-color: transparent;
      border: 1px solid var(--border);
      color: var(--foreground);
    }

    .button-outline:hover {
      background-color: var(--muted);
    }

    .button-icon {
      padding: 0.5rem;
    }

    /* Language Selector */
    .language-selector {
      display: flex;
      justify-content: flex-end;
      margin-bottom: 1rem;
    }

    /* Grid & Flexbox */
    .flex {
      display: flex;
    }

    .flex-col {
      flex-direction: column;
    }

    .items-center {
      align-items: center;
    }

    .justify-center {
      justify-content: center;
    }

    .justify-end {
      justify-content: flex-end;
    }

    .space-x-2 > * + * {
      margin-left: 0.5rem;
    }

    [dir="rtl"] .space-x-2 > * + * {
      margin-left: 0;
      margin-right: 0.5rem;
    }

    .space-y-2 > * + * {
      margin-top: 0.5rem;
    }

    .grid {
      display: grid;
    }

    .grid-cols-1 {
      grid-template-columns: 1fr;
    }

    @media (min-width: 768px) {
      .md\:grid-cols-2 {
        grid-template-columns: repeat(2, 1fr);
      }

      .md\:flex-row {
        flex-direction: row;
      }
    }

    .gap-4 {
      gap: 1rem;
    }

    .p-4 {
      padding: 1rem;
    }

    .mt-4 {
      margin-top: 1rem;
    }

    .mt-8 {
      margin-top: 2rem;
    }

    .rounded-md {
      border-radius: var(--radius);
    }

    .bg-primary\/10 {
      background-color: rgba(15, 23, 42, 0.1);
    }
    
    .text-center {
      text-align: center;
    }

    .text-lg {
      font-size: 1.125rem;
    }

    .text-sm {
      font-size: 0.875rem;
    }

    .text-2xl {
      font-size: 1.5rem;
    }

    .text-3xl {
      font-size: 1.875rem;
    }

    .font-bold {
      font-weight: 700;
    }

    .font-semibold {
      font-weight: 600;
    }

    .text-muted-foreground {
      color: var(--muted-foreground);
    }

    .text-destructive {
      color: var(--destructive);
    }

    .bg-destructive\/10 {
      background-color: rgba(239, 68, 68, 0.1);
    }

    .my-2 {
      margin-top: 0.5rem;
      margin-bottom: 0.5rem;
    }

    /* Tabs */
    .tabs {
      display: flex;
      border-bottom: 1px solid var(--border);
      margin-bottom: 1rem;
    }

    .tab {
      padding: 0.5rem 1rem;
      cursor: pointer;
      border-bottom: 2px solid transparent;
    }

    .tab.active {
      border-bottom-color: var(--primary);
    }

    /* Chart Styles */
    .chart-container {
      width: 100%;
      height: 300px;
      position: relative;
    }

    /* Toast */
    .toast-container {
      position: fixed;
      bottom: 1rem;
      right: 1rem;
      max-width: 350px;
      z-index: 50;
    }

    .toast {
      background-color: var(--card);
      border-left: 4px solid var(--primary);
      padding: 1rem;
      margin-top: 0.5rem;
      border-radius: var(--radius);
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      animation: slideIn 0.3s ease forwards;
    }

    .toast.error {
      border-left-color: var(--destructive);
    }

    .toast-title {
      font-weight: bold;
      margin-bottom: 0.25rem;
    }

    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    [dir="rtl"] @keyframes slideIn {
      from {
        transform: translateX(-100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="language-selector">
      <button id="language-toggle" class="button button-outline">English</button>
    </div>
    
    <div id="crypto-converter" class="card">
      <!-- Conversion Form -->
      <div class="space-y-6">
        <div class="flex flex-col md:flex-row gap-4 md:items-center">
          <div class="flex-1">
            <label id="amount-label" class="block" for="amount">Amount</label>
            <input
              id="amount"
              type="number"
              min="0"
              step="0.01"
              value="1"
            />
          </div>
          
          <div class="flex-1">
            <label id="from-label" class="block" for="from-currency">From</label>
            <select id="from-currency">
              <option value="bitcoin">Bitcoin (BTC)</option>
              <option value="ethereum">Ethereum (ETH)</option>
              <option value="binancecoin">Binance Coin (BNB)</option>
              <option value="ripple">XRP (XRP)</option>
              <option value="cardano">Cardano (ADA)</option>
              <option value="solana">Solana (SOL)</option>
              <option value="polkadot">Polkadot (DOT)</option>
              <option value="dogecoin">Dogecoin (DOGE)</option>
            </select>
          </div>
          
          <div class="flex items-center justify-center py-4 md:py-0">
            <button id="swap-button" class="button button-outline button-icon">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="m16 3 4 4-4 4"></path>
                <path d="M20 7H9a5 5 0 0 0-5 5 3 3 0 0 0 3 3h1"></path>
                <path d="m8 21-4-4 4-4"></path>
                <path d="M4 17h11a5 5 0 0 0 5-5 3 3 0 0 0-3-3h-1"></path>
              </svg>
            </button>
          </div>
          
          <div class="flex-1">
            <label id="to-label" class="block" for="to-currency">To</label>
            <select id="to-currency">
              <option value="usd">US Dollar (USD)</option>
              <option value="eur">Euro (EUR)</option>
              <option value="gbp">British Pound (GBP)</option>
              <option value="jpy">Japanese Yen (JPY)</option>
              <option value="aed">UAE Dirham (AED)</option>
              <option value="sar">Saudi Riyal (SAR)</option>
              <option value="egp">Egyptian Pound (EGP)</option>
            </select>
          </div>
        </div>
        
        <div class="flex justify-center gap-2">
          <button id="convert-button" class="button button-primary px-8">Convert</button>
          
          <button id="favorite-button" class="button button-outline button-icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"></path>
            </svg>
          </button>
        </div>
      </div>
      
      <!-- Conversion Result -->
      <div id="result-container" class="mt-4" style="display: none;">
        <div class="bg-primary/10 p-4 rounded-md text-center">
          <div id="result-label" class="text-lg font-semibold">Result</div>
          <div id="result-amount" class="text-3xl font-bold my-2"></div>
          <div id="last-updated" class="text-sm text-muted-foreground"></div>
        </div>
        
        <div id="price-data" class="flex flex-col gap-4 mt-4" style="display: none;">
          <div id="price-history" class="card">
            <div id="price-history-title" class="card-title">Price History</div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div class="flex flex-col p-4 bg-primary/10 rounded-md">
                <span id="price-change-percent" class="text-2xl font-bold"></span>
                <span id="price-change-label" class="text-sm text-muted-foreground">7-day Change (%)</span>
              </div>
              <div class="flex flex-col p-4 bg-primary/10 rounded-md">
                <span id="price-change-value" class="text-2xl font-bold"></span>
                <span id="price-value-label" class="text-sm text-muted-foreground">7-day Change ($)</span>
              </div>
            </div>
          </div>
          
          <div id="price-chart" class="card">
            <div id="price-chart-title" class="card-title">Price Chart</div>
            <div class="chart-container">
              <canvas id="price-chart-canvas"></canvas>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Usage Stats -->
      <div id="usage-stats" class="card mt-8">
        <div id="usage-stats-title" class="card-title">Usage Statistics</div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="flex flex-col items-center p-4 bg-primary/10 rounded-md">
            <span id="today-count" class="text-2xl font-bold">0</span>
            <span id="today-label" class="text-sm text-muted-foreground">Today's Conversions</span>
          </div>
          <div class="flex flex-col items-center p-4 bg-primary/10 rounded-md">
            <span id="total-count" class="text-2xl font-bold">0</span>
            <span id="total-label" class="text-sm text-muted-foreground">Total Conversions</span>
          </div>
        </div>
      </div>
      
      <!-- Tabs -->
      <div id="tabs" class="mt-8">
        <div class="tabs">
          <div id="favorites-tab" class="tab active">Favorites</div>
          <div id="trending-tab" class="tab">Trending</div>
          <div id="alerts-tab" class="tab">Alerts</div>
        </div>
        
        <div id="tab-content" class="card">
          <!-- Favorites Tab Content -->
          <div id="favorites-content" class="tab-content">
            <div id="no-favorites" class="text-center text-muted-foreground p-4">No favorites yet. Click the heart icon to add favorites.</div>
            <div id="favorites-list"></div>
          </div>
          
          <!-- Trending Tab Content -->
          <div id="trending-content" class="tab-content" style="display: none;">
            <div id="trending-list" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
          </div>
          
          <!-- Alerts Tab Content -->
          <div id="alerts-content" class="tab-content" style="display: none;">
            <div id="no-alerts" class="text-center text-muted-foreground p-4">No price alerts set.</div>
            <div id="alerts-list"></div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>
  </div>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  
  <script>
    // Translations
    const translations = {
      en: {
        amount: "Amount",
        from: "From",
        to: "To",
        swap: "Swap",
        convert: "Convert",
        converting: "Converting...",
        addToFavorites: "Add to Favorites",
        removeFromFavorites: "Remove from Favorites",
        resultLabel: "Result",
        lastUpdated: "Last updated",
        priceHistory: "Price History",
        dayChange: "7-day Change (%)",
        valueChange: "7-day Change ($)",
        priceChart: "Price Chart",
        usageStats: "Usage Statistics",
        todayConversions: "Today's Conversions",
        totalConversions: "Total Conversions",
        favorites: "Favorites",
        trending: "Trending",
        alerts: "Alerts",
        noFavorites: "No favorites yet. Click the heart icon to add favorites.",
        noAlerts: "No price alerts set.",
        trendingCoins: "Trending Coins",
        successTitle: "Success",
        errorTitle: "Error",
        addedToFavorites: "Added to favorites.",
        removedFromFavorites: "Removed from favorites.",
        errorFetchingPrice: "Failed to fetch price data. Please try again later.",
        selectCrypto: "Select cryptocurrency",
        selectFiat: "Select fiat currency",
      },
      ar: {
        amount: "المبلغ",
        from: "من",
        to: "إلى",
        swap: "تبديل",
        convert: "تحويل",
        converting: "جارِ التحويل...",
        addToFavorites: "إضافة إلى المفضلة",
        removeFromFavorites: "إزالة من المفضلة",
        resultLabel: "النتيجة",
        lastUpdated: "آخر تحديث",
        priceHistory: "تاريخ السعر",
        dayChange: "التغير خلال 7 أيام (%)",
        valueChange: "التغير خلال 7 أيام ($)",
        priceChart: "رسم بياني للسعر",
        usageStats: "إحصائيات الاستخدام",
        todayConversions: "تحويلات اليوم",
        totalConversions: "إجمالي التحويلات",
        favorites: "المفضلة",
        trending: "الرائج",
        alerts: "التنبيهات",
        noFavorites: "لا توجد عملات مفضلة بعد. انقر على أيقونة القلب لإضافة المفضلة.",
        noAlerts: "لم يتم تعيين تنبيهات للأسعار.",
        trendingCoins: "العملات الرائجة",
        successTitle: "نجاح",
        errorTitle: "خطأ",
        addedToFavorites: "تمت الإضافة إلى المفضلة.",
        removedFromFavorites: "تمت الإزالة من المفضلة.",
        errorFetchingPrice: "فشل في جلب بيانات السعر. يرجى المحاولة مرة أخرى لاحقًا.",
        selectCrypto: "اختر عملة رقمية",
        selectFiat: "اختر عملة تقليدية",
      }
    };

    // Cryptocurrencies with their symbols
    const cryptocurrencies = [
      { id: "bitcoin", name: "Bitcoin", symbol: "btc" },
      { id: "ethereum", name: "Ethereum", symbol: "eth" },
      { id: "binancecoin", name: "Binance Coin", symbol: "bnb" },
      { id: "ripple", name: "XRP", symbol: "xrp" },
      { id: "cardano", name: "Cardano", symbol: "ada" },
      { id: "solana", name: "Solana", symbol: "sol" },
      { id: "polkadot", name: "Polkadot", symbol: "dot" },
      { id: "dogecoin", name: "Dogecoin", symbol: "doge" }
    ];

    // Fiat currencies with their symbols
    const fiatCurrencies = [
      { id: "usd", name: "US Dollar", symbol: "usd" },
      { id: "eur", name: "Euro", symbol: "eur" },
      { id: "gbp", name: "British Pound", symbol: "gbp" },
      { id: "jpy", name: "Japanese Yen", symbol: "jpy" },
      { id: "aed", name: "UAE Dirham", symbol: "aed" },
      { id: "sar", name: "Saudi Riyal", symbol: "sar" },
      { id: "egp", name: "Egyptian Pound", symbol: "egp" }
    ];

    // App state
    let state = {
      language: "en",
      fromCurrency: "bitcoin",
      toCurrency: "usd",
      amount: 1,
      convertedAmount: null,
      lastUpdated: "",
      priceData: null,
      loading: false,
      error: "",
      favorites: [],
      chart: null
    };

    // DOM selectors
    const elements = {
      languageToggle: document.getElementById("language-toggle"),
      amountInput: document.getElementById("amount"),
      fromCurrencySelect: document.getElementById("from-currency"),
      toCurrencySelect: document.getElementById("to-currency"),
      convertButton: document.getElementById("convert-button"),
      swapButton: document.getElementById("swap-button"),
      favoriteButton: document.getElementById("favorite-button"),
      resultContainer: document.getElementById("result-container"),
      resultAmount: document.getElementById("result-amount"),
      lastUpdated: document.getElementById("last-updated"),
      priceData: document.getElementById("price-data"),
      priceChangePercent: document.getElementById("price-change-percent"),
      priceChangeValue: document.getElementById("price-change-value"),
      todayCount: document.getElementById("today-count"),
      totalCount: document.getElementById("total-count"),
      favoritesTab: document.getElementById("favorites-tab"),
      trendingTab: document.getElementById("trending-tab"),
      alertsTab: document.getElementById("alerts-tab"),
      favoritesContent: document.getElementById("favorites-content"),
      trendingContent: document.getElementById("trending-content"),
      alertsContent: document.getElementById("alerts-content"),
      favoritesList: document.getElementById("favorites-list"),
      noFavorites: document.getElementById("no-favorites"),
      trendingList: document.getElementById("trending-list"),
      chartCanvas: document.getElementById("price-chart-canvas"),
    };

    // Update UI text based on selected language
    function updateUILanguage() {
      const t = translations[state.language];
      
      // Update document direction
      document.documentElement.setAttribute('dir', state.language === 'ar' ? 'rtl' : 'ltr');
      
      // Update button text
      elements.languageToggle.textContent = state.language === 'ar' ? 'English' : 'العربية';
      elements.convertButton.textContent = state.loading ? t.converting : t.convert;
      
      // Update labels
      document.getElementById("amount-label").textContent = t.amount;
      document.getElementById("from-label").textContent = t.from;
      document.getElementById("to-label").textContent = t.to;
      document.getElementById("result-label").textContent = t.resultLabel;
      document.getElementById("price-history-title").textContent = t.priceHistory;
      document.getElementById("price-chart-title").textContent = t.priceChart;
      document.getElementById("usage-stats-title").textContent = t.usageStats;
      document.getElementById("price-change-label").textContent = t.dayChange;
      document.getElementById("price-value-label").textContent = t.valueChange;
      document.getElementById("today-label").textContent = t.todayConversions;
      document.getElementById("total-label").textContent = t.totalConversions;
      
      // Update tabs
      document.getElementById("favorites-tab").textContent = t.favorites;
      document.getElementById("trending-tab").textContent = t.trending;
      document.getElementById("alerts-tab").textContent = t.alerts;
      document.getElementById("no-favorites").textContent = t.noFavorites;
      document.getElementById("no-alerts").textContent = t.noAlerts;
      
      // Update heart button tooltip
      const isFavorite = isFavoriteConversion(state.fromCurrency, state.toCurrency);
      elements.favoriteButton.title = isFavorite ? t.removeFromFavorites : t.addToFavorites;
      
      // If we have result data, update it for the new language
      if (state.convertedAmount !== null) {
        updateConversionResult();
      }
      
      // Update tabs content
      renderFavorites();
    }

    // Toggle language between English and Arabic
    function toggleLanguage() {
      state.language = state.language === 'en' ? 'ar' : 'en';
      updateUILanguage();
    }

    // Format currency amount for display
    function formatCurrency(amount, currency) {
      return new Intl.NumberFormat(state.language === 'ar' ? 'ar-SA' : 'en-US', {
        style: 'currency',
        currency: currency.toUpperCase(),
        minimumFractionDigits: amount < 1 ? 6 : 2,
        maximumFractionDigits: amount < 1 ? 6 : 2
      }).format(amount);
    }

    // Show toast notification
    function showToast(title, message, type = 'success') {
      const toastContainer = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.className = `toast ${type === 'error' ? 'error' : ''}`;
      
      toast.innerHTML = `
        <div class="toast-title">${title}</div>
        <div>${message}</div>
      `;
      
      toastContainer.appendChild(toast);
      
      setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => {
          toastContainer.removeChild(toast);
        }, 300);
      }, 3000);
    }

    // Update usage statistics
    function updateStats() {
      // Get today's date in YYYY-MM-DD format
      const today = new Date().toISOString().split('T')[0];
      
      // Get the stats from localStorage
      const storedStats = localStorage.getItem('cryptoConverterStats');
      let stats = storedStats ? JSON.parse(storedStats) : {};
      
      // If no stats for today, initialize to 0
      if (!stats[today]) {
        stats[today] = 0;
      }
      
      // Increment the counter
      stats[today]++;
      
      // Save back to localStorage
      localStorage.setItem('cryptoConverterStats', JSON.stringify(stats));
      
      // Update the UI
      elements.todayCount.textContent = stats[today] || 0;
      
      // Calculate total count across all days - fixing the type issue
      const total = Object.values(stats).reduce((acc, curr) => {
        return acc + (typeof curr === 'number' ? curr : 0);
      }, 0);
      
      elements.totalCount.textContent = total;
    }

    // Load usage stats on startup
    function loadStats() {
      // Get today's date in YYYY-MM-DD format
      const today = new Date().toISOString().split('T')[0];
      
      // Get the stats from localStorage
      const storedStats = localStorage.getItem('cryptoConverterStats');
      const stats = storedStats ? JSON.parse(storedStats) : {};
      
      // Update today's count
      const todayStats = stats[today] || 0;
      elements.todayCount.textContent = todayStats;
      
      // Calculate total count across all days - fixing the type issue
      const total = Object.values(stats).reduce((acc, curr) => {
        return acc + (typeof curr === 'number' ? curr : 0);
      }, 0);
      
      elements.totalCount.textContent = total;
    }

    // Fetch cryptocurrency price
    async function fetchPrice() {
      if (!state.fromCurrency || !state.toCurrency) {
        return;
      }

      state.loading = true;
      state.error = '';
      elements.convertButton.textContent = translations[state.language].converting;

      try {
        const response = await fetch(
          `https://api.coingecko.com/api/v3/simple/price?ids=${state.fromCurrency}&vs_currencies=${state.toCurrency}&include_24hr_change=true&include_last_updated_at=true`
        );

        if (!response.ok) {
          throw new Error(`API request failed with status ${response.status}`);
        }

        const data = await response.json();
        
        if (!data[state.fromCurrency] || !data[state.fromCurrency][state.toCurrency]) {
          throw new Error(`Price data not available for ${state.fromCurrency} to ${state.toCurrency}`);
        }

        const price = data[state.fromCurrency][state.toCurrency];
        const lastUpdateTime = new Date(data[state.fromCurrency].last_updated_at * 1000);

        state.convertedAmount = state.amount * price;
        state.lastUpdated = lastUpdateTime.toLocaleString(
          state.language === 'ar' ? 'ar-SA' : 'en-US'
        );

        // Fetch historical data for chart
        await fetchHistoricalData();
        
        // Update usage stats
        updateStats();
        
        // Update the UI
        updateConversionResult();
        
        // Save current conversion to localStorage
        localStorage.setItem(
          'lastConversion',
          JSON.stringify({
            fromCurrency: state.fromCurrency,
            toCurrency: state.toCurrency,
            amount: state.amount
          })
        );
      } catch (err) {
        console.error('Error fetching price:', err);
        state.error = translations[state.language].errorFetchingPrice;
        showToast(
          translations[state.language].errorTitle, 
          translations[state.language].errorFetchingPrice,
          'error'
        );
        state.convertedAmount = null;
      } finally {
        state.loading = false;
        elements.convertButton.textContent = translations[state.language].convert;
      }
    }

    // Fetch historical price data
    async function fetchHistoricalData() {
      try {
        const response = await fetch(
          `https://api.coingecko.com/api/v3/coins/${state.fromCurrency}/market_chart?vs_currency=${state.toCurrency}&days=7&interval=daily`
        );

        if (!response.ok) {
          throw new Error('Failed to fetch historical data');
        }

        const data = await response.json();
        state.priceData = data;
        
        // Display the price data section
        elements.priceData.style.display = 'flex';
        
        // Calculate 7-day change
        if (data.prices && data.prices.length >= 2) {
          const oldPrice = data.prices[0][1];
          const newPrice = data.prices[data.prices.length - 1][1];
          const changePercent = ((newPrice - oldPrice) / oldPrice) * 100;
          const changeValue = newPrice - oldPrice;
          
          elements.priceChangePercent.textContent = `${changePercent >= 0 ? '+' : ''}${changePercent.toFixed(2)}%`;
          elements.priceChangePercent.style.color = changePercent >= 0 ? '#10b981' : '#ef4444';
          
          elements.priceChangeValue.textContent = formatCurrency(changeValue, state.toCurrency);
          elements.priceChangeValue.style.color = changeValue >= 0 ? '#10b981' : '#ef4444';
        }
        
        // Create chart
        createChart(data);
      } catch (err) {
        console.error('Error fetching historical data:', err);
        elements.priceData.style.display = 'none';
        state.priceData = null;
      }
    }

    // Update the conversion result UI
    function updateConversionResult() {
      const t = translations[state.language];
      
      if (state.error) {
        elements.resultContainer.innerHTML = `
          <div class="bg-destructive/10 text-destructive p-3 rounded-md text-center">
            ${state.error}
          </div>
        `;
        elements.resultContainer.style.display = 'block';
        return;
      }

      if (state.convertedAmount === null) {
        elements.resultContainer.style.display = 'none';
        return;
      }

      elements.resultContainer.style.display = 'block';
      elements.resultAmount.textContent = formatCurrency(state.convertedAmount, state.toCurrency);
      elements.lastUpdated.textContent = `${t.lastUpdated}: ${state.lastUpdated}`;
    }

    // Create price chart
    function createChart(data) {
      if (!data || !data.prices || data.prices.length === 0) return;
      
      // Destroy existing chart if it exists
      if (state.chart) {
        state.chart.destroy();
      }
      
      // Format dates for chart
      const labels = data.prices.map(price => {
        const date = new Date(price[0]);
        return date.toLocaleDateString(state.language === 'ar' ? 'ar-SA' : 'en-US', {
          month: 'short',
          day: 'numeric'
        });
      });
      
      const priceValues = data.prices.map(price => price[1]);
      
      // Create a gradient for the chart area
      const ctx = elements.chartCanvas.getContext('2d');
      const gradient = ctx.createLinearGradient(0, 0, 0, 400);
      gradient.addColorStop(0, 'rgba(15, 23, 42, 0.3)');
      gradient.addColorStop(1, 'rgba(15, 23, 42, 0.0)');
      
      // Create the chart
      state.chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: `${state.fromCurrency.toUpperCase()} Price`,
            data: priceValues,
            borderColor: 'rgb(15, 23, 42)',
            backgroundColor: gradient,
            borderWidth: 2,
            fill: true,
            tension: 0.4,
            pointRadius: 3,
            pointBackgroundColor: 'rgb(15, 23, 42)'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return formatCurrency(context.raw, state.toCurrency);
                }
              }
            }
          },
          scales: {
            x: {
              grid: {
                display: false
              }
            },
            y: {
              position: state.language === 'ar' ? 'right' : 'left',
              grid: {
                color: 'rgba(15, 23, 42, 0.1)'
              },
              ticks: {
                callback: function(value) {
                  return formatCurrency(value, state.toCurrency);
                }
              }
            }
          }
        }
      });
    }

    // Load favorites from localStorage
    function loadFavorites() {
      const storedFavorites = localStorage.getItem('cryptoFavorites');
      if (storedFavorites) {
        try {
          const parsedFavorites = JSON.parse(storedFavorites);
          state.favorites = Array.isArray(parsedFavorites) ? parsedFavorites : [];
        } catch (error) {
          console.error('Error parsing favorites from localStorage', error);
          state.favorites = [];
        }
      }
      updateFavoriteButtonState();
      renderFavorites();
    }

    // Save favorites to localStorage
    function saveFavorites() {
      localStorage.setItem('cryptoFavorites', JSON.stringify(state.favorites));
      renderFavorites();
    }

    // Check if conversion is in favorites
    function isFavoriteConversion(fromCurrency, toCurrency) {
      return state.favorites.some(
        item => 
          item.fromCurrency === fromCurrency && 
          item.toCurrency === toCurrency
      );
    }

    // Toggle favorite status
    function toggleFavorite() {
      const t = translations[state.language];
      const isFavorite = isFavoriteConversion(state.fromCurrency, state.toCurrency);
      
      if (isFavorite) {
        state.favorites = state.favorites.filter(
          item => !(item.fromCurrency === state.fromCurrency && item.toCurrency === state.toCurrency)
        );
        showToast(t.successTitle, t.removedFromFavorites);
      } else {
        state.favorites.push({
          fromCurrency: state.fromCurrency,
          toCurrency: state.toCurrency,
          amount: state.amount
        });
        showToast(t.successTitle, t.addedToFavorites);
      }
      
      saveFavorites();
      updateFavoriteButtonState();
    }

    // Update favorite button appearance
    function updateFavoriteButtonState() {
      const isFavorite = isFavoriteConversion(state.fromCurrency, state.toCurrency);
      const heartIcon = elements.favoriteButton.querySelector('svg');
      
      if (isFavorite) {
        heartIcon.setAttribute('fill', 'currentColor');
        elements.favoriteButton.classList.add('text-red-500');
      } else {
        heartIcon.setAttribute('fill', 'none');
        elements.favoriteButton.classList.remove('text-red-500');
      }
      
      elements.favoriteButton.title = translations[state.language][
        isFavorite ? 'removeFromFavorites' : 'addToFavorites'
      ];
    }

    // Render favorites list
    function renderFavorites() {
      const t = translations[state.language];
      
      if (state.favorites.length === 0) {
        elements.noFavorites.style.display = 'block';
        elements.favoritesList.innerHTML = '';
        return;
      }
      
      elements.noFavorites.style.display = 'none';
      elements.favoritesList.innerHTML = '';
      
      state.favorites.forEach((favorite, index) => {
        const fromCurrency = cryptocurrencies.find(c => c.id === favorite.fromCurrency);
        const toCurrency = fiatCurrencies.find(c => c.id === favorite.toCurrency);
        
        if (!fromCurrency || !toCurrency) return;
        
        const favoriteItem = document.createElement('div');
        favoriteItem.className = 'p-4 border-b last:border-b-0';
        favoriteItem.innerHTML = `
          <div class="flex justify-between items-center">
            <div>
              <div class="font-semibold">${favorite.amount} ${fromCurrency.name} (${fromCurrency.symbol.toUpperCase()})</div>
              <div class="text-sm text-muted-foreground">${t.to} ${toCurrency.name} (${toCurrency.symbol.toUpperCase()})</div>
            </div>
            <div class="flex space-x-2">
              <button class="button button-outline load-favorite" data-index="${index}">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="m3 12 7-7 7 7"></path>
                  <path d="M10 5v14"></path>
                </svg>
              </button>
              <button class="button button-outline remove-favorite" data-index="${index}">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M3 6h18"></path>
                  <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
                  <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
                  <line x1="10" x2="10" y1="11" y2="17"></line>
                  <line x1="14" x2="14" y1="11" y2="17"></line>
                </svg>
              </button>
            </div>
          </div>
        `;
        
        elements.favoritesList.appendChild(favoriteItem);
      });
      
      // Add event listeners to the buttons
      document.querySelectorAll('.load-favorite').forEach(button => {
        button.addEventListener('click', function() {
          const index = parseInt(this.dataset.index, 10);
          const favorite = state.favorites[index];
          
          if (favorite) {
            state.fromCurrency = favorite.fromCurrency;
            state.toCurrency = favorite.toCurrency;
            state.amount = favorite.amount;
            
            // Update the form
            elements.fromCurrencySelect.value = favorite.fromCurrency;
            elements.toCurrencySelect.value = favorite.toCurrency;
            elements.amountInput.value = favorite.amount;
            
            // Update favorite button
            updateFavoriteButtonState();
            
            // Perform the conversion
            fetchPrice();
          }
        });
      });
      
      document.querySelectorAll('.remove-favorite').forEach(button => {
        button.addEventListener('click', function() {
          const index = parseInt(this.dataset.index, 10);
          
          if (index >= 0 && index < state.favorites.length) {
            state.favorites.splice(index, 1);
            saveFavorites();
            
            // Update UI if current conversion was removed
            updateFavoriteButtonState();
          }
        });
      });
    }

    // Fetch trending cryptocurrencies
    async function fetchTrending() {
      try {
        const response = await fetch('https://api.coingecko.com/api/v3/search/trending');
        
        if (!response.ok) {
          throw new Error(`API request failed with status ${response.status}`);
        }
        
        const data = await response.json();
        
        if (!data.coins) {
          throw new Error('No trending data available');
        }
        
        renderTrending(data.coins.slice(0, 6));
      } catch (err) {
        console.error('Error fetching trending coins:', err);
        elements.trendingList.innerHTML = `
          <div class="text-center text-muted-foreground p-4">
            Failed to load trending cryptocurrencies.
          </div>
        `;
      }
    }

    // Render trending cryptocurrencies
    function renderTrending(trendingCoins) {
      elements.trendingList.innerHTML = '';
      
      trendingCoins.forEach(coin => {
        const item = coin.item;
        const trendingItem = document.createElement('div');
        trendingItem.className = 'flex flex-col p-4 bg-primary/10 rounded-md';
        trendingItem.innerHTML = `
          <div class="flex items-center gap-2">
            <img src="${item.small}" alt="${item.name}" class="w-6 h-6 rounded-full" />
            <span class="font-semibold">${item.name}</span>
            <span class="text-sm text-muted-foreground">${item.symbol}</span>
          </div>
          <div class="mt-2">
            <div class="text-sm text-muted-foreground">
              Market Cap Rank: ${item.market_cap_rank || 'N/A'}
            </div>
          </div>
          <button class="button button-primary mt-2 use-trending" data-id="${item.id}">
            Use
          </button>
        `;
        
        elements.trendingList.appendChild(trendingItem);
      });
      
      // Add event listeners
      document.querySelectorAll('.use-trending').forEach(button => {
        button.addEventListener('click', function() {
          const coinId = this.dataset.id;
          
          // Update from currency
          state.fromCurrency = coinId;
          elements.fromCurrencySelect.value = cryptocurrencies.find(c => c.id === coinId)?.id || coinId;
          
          // Switch to the main tab
          switchTab('favorites-tab');
          
          // Update favorite button state
          updateFavoriteButtonState();
          
          // Perform the conversion
          fetchPrice();
        });
      });
    }

    // Switch between tabs
    function switchTab(tabId) {
      // Remove active class from all tabs
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
      });
      
      // Hide all tab content
      document.querySelectorAll('.tab-content').forEach(content => {
        content.style.display = 'none';
      });
      
      // Set active tab and show content
      document.getElementById(tabId).classList.add('active');
      
      let contentId;
      if (tabId === 'favorites-tab') {
        contentId = 'favorites-content';
      } else if (tabId === 'trending-tab') {
        contentId = 'trending-content';
        // Load trending data when tab is selected
        fetchTrending();
      } else if (tabId === 'alerts-tab') {
        contentId = 'alerts-content';
      }
      
      if (contentId) {
        document.getElementById(contentId).style.display = 'block';
      }
    }

    // Handle form submission (convert button click)
    function handleConvert() {
      // Get values from form
      state.amount = parseFloat(elements.amountInput.value) || 0;
      state.fromCurrency = elements.fromCurrencySelect.value;
      state.toCurrency = elements.toCurrencySelect.value;
      
      // Perform conversion
      fetchPrice();
    }

    // Handle currency swap
    function handleSwap() {
      // Swap currencies
      const tempCurrency = state.fromCurrency;
      state.fromCurrency = state.toCurrency;
      state.toCurrency = tempCurrency;
      
      // Update select elements
      elements.fromCurrencySelect.value = state.fromCurrency;
      elements.toCurrencySelect.value = state.toCurrency;
      
      // Update favorite button
      updateFavoriteButtonState();
      
      // Perform conversion with swapped currencies
      fetchPrice();
    }

    // Initialize the app
    function init() {
      // Load saved conversion from localStorage
      const savedConversion = localStorage.getItem('lastConversion');
      if (savedConversion) {
        try {
          const { fromCurrency, toCurrency, amount } = JSON.parse(savedConversion);
          state.fromCurrency = fromCurrency || 'bitcoin';
          state.toCurrency = toCurrency || 'usd';
          state.amount = amount || 1;
          
          // Update UI
          elements.fromCurrencySelect.value = state.fromCurrency;
          elements.toCurrencySelect.value = state.toCurrency;
          elements.amountInput.value = state.amount;
        } catch (error) {
          console.error('Error parsing saved conversion', error);
        }
      }
      
      // Set up event listeners
      elements.languageToggle.addEventListener('click', toggleLanguage);
      elements.convertButton.addEventListener('click', handleConvert);
      elements.swapButton.addEventListener('click', handleSwap);
      elements.favoriteButton.addEventListener('click', toggleFavorite);
      
      // Tab event listeners
      elements.favoritesTab.addEventListener('click', () => switchTab('favorites-tab'));
      elements.trendingTab.addEventListener('click', () => switchTab('trending-tab'));
      elements.alertsTab.addEventListener('click', () => switchTab('alerts-tab'));
      
      // Input change listeners
      elements.amountInput.addEventListener('input', () => {
        state.amount = parseFloat(elements.amountInput.value) || 0;
      });
      
      elements.fromCurrencySelect.addEventListener('change', () => {
        state.fromCurrency = elements.fromCurrencySelect.value;
        updateFavoriteButtonState();
      });
      
      elements.toCurrencySelect.addEventListener('change', () => {
        state.toCurrency = elements.toCurrencySelect.value;
        updateFavoriteButtonState();
      });
      
      // Load favorites and stats
      loadFavorites();
      loadStats();
      
      // Set initial language
      updateUILanguage();
      
      // Do initial conversion
      fetchPrice();
    }

    // Start the app
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
